function Engine(){
	// Grabs data from the server to initialize the game state
	var charactersInfo = this.updateServersideState(undefined);
	this.keys = {
					'left':false,
					'right':false,
					'up':false,
					'down':false
				};

	this.FPS = 60; // this is the FPS it aims to run at
	this.updateCounter = 0;
	this.charactersList = [];

	for (var i = charactersInfo.length - 1; i >= 0; i--) {
		this.charactersList.push(new character(charactersInfo[i]));
	};

	setInterval(Engine.mainLoop.bind(this), // Hack to get past this being set to the wrong
				(this.FPS / 1000))
}

// sends the user data and downloads a JSON object
// ONLY RUNS ONCE PER SECOND
// @param mixed userData An object generated by the Engine object, or undefined for the first connection
Engine.prototype.updateServersideState = function(userData){
	if(userData === undefined){
		var arguments = "";
	}else{
		var arguments = "userData="+JSON.stringify(userData)
	}

	var http = new XMLHttpRequest();
	
	http.abort();
	http.open("POST", "updateState.php", true);
	http.onreadystatechange=function() {
		return JSON.decode(http.responseText);
	}
	http.setRequestHeader("Content-length", arguments.length);
	http.setRequestHeader('Content-Type', "application/x-www-form-urlencoded; charset=utf-8");
	http.send(parametros);
}

// Attach this to BOTH the keydown AND keyup events.
Engine.prototype.keysPressed = function(e){
	e = e || window.event;

	action = (e.type == "keydown") ? true : false;

	switch(e.keyCode){
		case '37': // left
			this.keys.left = action;
			break;
		case '38': // up
			this.keys.up = action;
			break;
		case '39': // right
			this.keys.right = action;
			break;
		case '40': // down
			this.keys.down = action;
			break;
	}
}

// This is used with setInterval
Engine.prototype.mainLoop = function(){
	var userData = this.updateMainChar();

	if(this.updateCounter >= this.FPS){ // Only sends and gets the new data sporadically as to not DDos the server
		var charactersInfo = this.updateServersideState(userData);
		this.updateCounter = 0;

		for (var i = charactersInfo.length - 1; i >= 0; i--) {
			this.updatecharacter(charactersInfo[i]);
		};
	}else{
		this.updateCounter += 1;
	}
}

Engine.prototype.drawChat = function (chats) {
	
}

Engine.prototype.updateMainChar = function(){
	if(this.mainChar.running){
		this.walkDistance = 5; // TODO: DEFINIR ESSES VALORESZ
	}else{
		this.walkDistance = 10;
	}

	if(this.keys.left){
		this.mainChar.posx -= this.walkDistance;
		this.mainChar.orientation = "left";
	};
	if(this.keys.right){
		this.mainChar.posx += this.walkDistance;
		this.mainChar.orientation = "right";
	};
	if(this.keys.up){
		this.mainChar.posy += this.walkDistance;
		this.mainChar.orientation = "up";
	};
	if(this.keys.down){
		this.mainChar.posy -= this.walkDistance
		this.mainChar.orientation = "down";
	};
}